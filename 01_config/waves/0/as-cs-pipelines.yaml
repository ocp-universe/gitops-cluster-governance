apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: as-core-cs-pipeline-snapshot
spec:
  generators:
  - matrix:
      generators:
      - git:
          repoURL: REPLACE_ME_URL
          revision: HEAD
          files:
          - path: REPLACE_ME_CLUSTER_YAML
      - merge:
          generators:
          - git:
              repoURL: REPLACE_ME_URL
              revision: HEAD
              files:
              - path: 01_config/versions/{{ cluster.platform_version }}/version.yaml
          - git:
              repoURL: REPLACE_ME_URL
              revision: HEAD
              files:
              - path: 01_config/clusters/{{ cluster.name }}/cluster.yaml
          mergeKeys:
          - versions
  template:
    metadata:
      name: core-cs-pipeline-snapshot
    spec:
      project: default
      source:
        repoURL: REPLACE_ME_URL
        targetRevision: "{{ versions.applications.snapshot_pipeline.revision }}"
        path: 02_capabilities/catalog-sources/pipelines-snapshot/overlays/{{ versions.applications.snapshot_pipeline.version }}
      destination:
        server: https://kubernetes.default.svc
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        retry:
          backoff:
            duration: 10s
            factor: 1
            maxDuration: 5m
          limit: 10
